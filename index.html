<!DOCTYPE html>
<html>
<meta charset="utf-8">
<head>
<style>

body {
  font-family: Arial;
}

.background {
  fill: none;
  pointer-events: all;
}

rect {
  fill: none;
  stroke: white;
}


.feature {
  fill: #ccc;
  cursor: pointer;
}

.feature.active {
  fill: orange;
}

.d3-tip {
  line-height: 1;
  font-weight: bold;
  padding: 12px;
  font-size: 12px;
  background: rgba(0, 0, 0, 0.8);
  color: #fff;
  border-radius: 2px;
}

/* Creates a small triangle extender for the tooltip */
.d3-tip:after {
  box-sizing: border-box;
  display: inline;
  font-size: 10px;
  width: 100%;
  line-height: 1;
  color: rgba(0, 0, 0, 0.8);
  content: "\25BC";
  position: absolute;
  text-align: center;
}

/* Style northward tooltips differently */
.d3-tip.n:after {
  margin: -1px 0 0 0;
  top: 100%;
  left: 0;
}
</style>
<link rel="stylesheet" href="style.css"/>  
<script src="d3.v3.min.js"></script>
<script src="topojson.v1.min.js"></script>
<script src="d3.tip.v0.6.3.js"></script>
<script src="autocomplete.js"></script>
</head>
<body>
<div id="searchBar"></div>
<script>

var width = 800,
    height = 400,
    active = d3.select(null);

var svg = d3.select("body").append("svg")
                                    .attr("width", width)
                                    .attr("height", height);

var tip = d3.tip()
  .attr('class', 'd3-tip')
  .offset([-10, 0])
  .html(function(d) {
    return "<span style='color:red'>" + d.employee + "</span></br>" + d.dept;
  })
 
svg.call(tip);

svg.append("rect")
    .attr("class", "background")
    .attr("width", width)
    .attr("height", height)
    .on("click", reset);

var borderPath = svg.append("rect")
.attr("x", 0)
.attr("y", 0)
.attr("height", height)
.attr("width", width)
.style("stroke", "#ccc")
.style("fill", "none")
.style("stroke-width", 1);


var g = svg.append("g")
    .style("stroke-width", "1.5px");

var path = d3.geo.path();

d3.json("seats.json", function(error, data) {
  var gg = g.selectAll("g")
    .data(data)
    .enter()
    .append("g")
    .attr("transform", function(d) { return "translate("+ d.x_axis + "," + d.y_axis + ")"; })
    .attr("align", "center")
    .attr("class", function(d) { return d.dept; })
    .on("click", clicked)
    .on('mouseover', tip.show)
    .on('mouseout', tip.hide);    

  gg.append("rect")
    // .attr("x", function (d) { return d.x_axis; })
    // .attr("y", function (d) { return d.y_axis; })
    .attr("height", function (d) { return d.height; })
    .attr("width", function (d) { return d.width; })
    .attr("id", function(d) { return d.employee.split(" ").join("-"); })
    .attr("class", "feature");
    // .style("fill", function (d) { getDeptColor()} );
    

  gg.append("text")
    .attr("x", function(d) {return d.width / 2; })
    .attr("y", function(d) { return d.height / 2 + 5; })
    .attr("text-anchor", "middle")
    .attr("fill", "#ffffff")
    .attr("cursor", "pointer")
    .attr("style", "font-size: 10px")
    .text(function(d) { 
      
      if (!d.employee) {
        console.log("here");
        return "";
      }
      else if (d.employee.indexOf(" ") > -1) {
        var name = d.employee.split(" ")
        var first_name = name[0];
        var last_name = name[1];
        return first_name.charAt(0) + last_name.charAt(0); 
      } else {
        return d.employee[0];
      }

    });

  var deptList = data.map(function(d) {return d.dept;});
  var depts = []

  for (var i in deptList) {
    if (depts.indexOf(deptList[i]) < 0) {
      depts.push(deptList[i]);
    }
  }
  console.log(depts);

  lastDept = null;

  var select = d3.select("body")
    .append("div")
    .append("select")
    .on("change", function() { 
      d3.selectAll("." + lastDept).select("rect").style("fill", "#ccc");
      d3.selectAll("." + this.value).select("rect").style("fill", "orange");
      lastDept = this.value;
    });

  select.selectAll("option")
      .data(depts)
    .enter().append("option")
      .attr("value", function(d) { return d; })
      .text(function(d) { return d; });


  });

function clicked(d) {
  var dis = d3.select(this).select("rect");
  if (active.node() === dis.node()) return reset();
  active.classed("active", false);
  
  console.log(dis); 

  active = dis.classed("active", true);

  zoom(d.width, d.height, d.x_axis, d.y_axis, width, height);
}

function zoom(dwidth, dheight, x_axis, y_axis, width, height) {
  var dx = dwidth,
      dy = dheight,
      x = x_axis + dwidth / 2,
      y = y_axis + dheight / 2

  var scale = .5 / Math.max(dx / width, dy / height),
      translate = [width / 2 - scale * x, height / 2 - scale * y];

  g.transition()
      .duration(750)
      .style("stroke-width", 1.5 / scale + "px")
      .attr("transform", "translate(" + translate + ")scale(" + scale + ")");

}

function reset() {
  active.classed("active", false);
  active = d3.select(null);

  g.transition()
      .duration(750)
      .style("stroke-width", "1.5px")
      .attr("transform", "");
}


    var keys = [];

    d3.json("seats.json", function(error, data) {
        for (var i = 0; i < data.length; i++) {
            keys.push(data[i]);
        }
        console.log(keys);
        start();
    });



    //Call back for when user selects an option
    function onSelect(d) {
      
      
      active.classed("active", false);
      
      var id = "#" + d.employee.split(" ").join("-");
      console.log(d3.select(id));
      active = d3.select(id).classed("active", true);

      zoom(d.width, d.height, d.x_axis, d.y_axis, width, height);
    }

    //Setup and render the autocomplete
    function start() {
        var mc = autocomplete("#searchBar")
                .keys(keys)
                .dataField("employee")
                .placeHolder("Search Employee - Start typing here")
                .width(960)
                .height(250)
                .onSelected(onSelect)
                .render();
    }



</script>

</body>
</html>